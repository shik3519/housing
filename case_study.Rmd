---
title: "case_study"
author: "Shikhar Gupta"
date: "9/25/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mice)
library(VIM)
library(missForest)
library(magrittr)
library(dplyr)
library(glmnet,quietly = T)
library(ISLR,quietly = T)
library(MASS)
library(olsrr)
library(fmsb)
library(car)
knitr::opts_chunk$set(echo = TRUE,cache = T,opts.label = "kill_prefix",fig.align='center',dev = 'pdf',tidy.opts=list(width.cutoff=60),tidy=TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(dev = 'jpeg')
source("vif_func.R")
```


```{r}
#loading data
data <- read.csv('~/housing.txt')
```

```{r}
#functions

#NA replacement as factor level
replace_NA <- function(x){
        y <- addNA(x)
        levels(y) <- c(levels(x),'absent')
        x <- y
}

#missing value counting
pMiss <- function(x){sum(is.na(x))/length(x)*100}

#variable remove
varremove <- function(df,varlist){
        df <- df[,!(colnames(df) %in% varlist)]   
        return(df)       
}

```



```{r}
# #missing values across variables for original data
# miss_count_pre <- as.data.frame(apply(data,2,pMiss)>0)
# 
# #visualizing distribution of missing values
# miss_col_data_pre <- data[,apply(data,2,pMiss)>0]
# 
# 
# aggr_plot <- aggr(miss_col_data_pre, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(miss_col_data_pre), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))

########Variable treatment and manual selection######################

#removing variables
data <- varremove(data,c('PoolQC','MiscFeature','Alley','FireplaceQu','Fence','Id','Utilities'))
data <- varremove(data,c('GarageYrBlt','GarageArea','GarageType','GarageFinish','GarageQual','GarageCond'))


#treating Masonry related variables
data$MasVnrArea[which(is.na(data$MasVnrArea))] <- 0
data$MasVnrType[which(is.na(data$MasVnrType))] <- 'None'


#treating bsmt related variables
data_bsmt <- data %>% dplyr::select(c(BsmtQual,BsmtCond,BsmtExposure,BsmtFinType1,BsmtFinType2))

data <- data %>% dplyr::select(-c(BsmtQual,BsmtCond,BsmtExposure,BsmtFinType1,BsmtFinType2))
#dataframe with NA replaced in categorical variables where NA is not a missing value
data_bsmt <- data_bsmt %>% sapply(replace_NA) %>% data.frame()

data <- cbind(data,data_bsmt)

#converting month sold to factors
data$MoSold <- as.factor(data$MoSold)

```



```{r}
#Missing value imputation using miss forest
data_imp <- missForest(data)

#error in the imputation
data_imp$OOBerror

#final imputed dataframe
data <- data_imp$ximp
```



```{r}
#creating data model
x <- model.matrix(SalePrice ~., data = data)
y <- data$SalePrice

#creating dataframe
df1 <- as.data.frame(cbind(y,x))


norm_diagnostic <- function(m){
        ols_rsd_qqplot(m)
        ols_norm_test(m)
}


###############OLS1####################
model1 <- lm(y~.,df1)
summary1 <- summary(model1)
coeff1 <- as.data.frame(summary1$coefficients)

######RESIDUAL DIAGNOSTICS#############

###Normality test########
norm_diagnostic(model1)

#####Error Autocorrelation test######
durbinWatsonTest(model1)

#####Constant variance#######
ols_rvsp_plot(model1)

ncvTest(model1)

#############LASSO for variable selection#############

set.seed(1) #for reproducability

#creating grid for lamda
grid.lambda <- 10^seq(10, -2, length = 100)

#cross validation to get best lambda
cv.out <- cv.glmnet(x, y, alpha = 1,lambda = grid.lambda)

best.lambda <- cv.out$lambda.min

plot(cv.out)
abline(v = log(best.lambda), col = "blue", lwd = 2)
#actual lasso model with the best lambda
final.model <- glmnet(x, y, alpha = 1, lambda = best.lambda)

Coef.Lasso <- coef(final.model)

#variables removed
var_remove <- names(Coef.Lasso[which(Coef.Lasso[,1]==0),1])

#new df with reduced variables
df2 <- varremove(df1,var_remove)

```



```{r}

#log transformation of response based on box cox
df1$y <- log(df1$y)

#############ols fit1#############
model2 <- lm(y~.,df1)
summary2 <- summary(model2)
coeff2 <- as.data.frame(summary2$coefficients)

#############residual diagnostic#############
e <- model2$residuals
std.residuals <- (e - mean(e)) / sd(e)

#test for normality
ols_rsd_qqplot(model2)

ols_norm_test(model2)


#test for constant variance
plot(df1$y,std.residuals)

#according to residual diagnostics we need y transformation due to failure of KS test

#############box cox for possible transformation#############
bc <- boxcox(y~.,data = df1)
bc$x[which(bc$y == max(bc$y))]

#lamda = 0.3
```


```{r}
#####Outlier treatment######
#dffits
dffits <- ols_dffits_plot(model2)
d.outlier <- dffits$outliers$Observation
#cooks distance
cook <- ols_cooksd_chart(model2)
c.outlier <- cook$outliers$Observation

#removing outlier observations: 84 observations
df2 <- df1[-c.outlier,]
```


```{r}
var1 <- c('SaleTypeCon','PoolArea','Condition2PosN','PoolQCFa','PoolQCGd')
df3 <- df2[,!colnames(df2) %in% var1]

#############ols fit2#############
model3 <- lm(y~.,df4)
summary3 <- summary(model3)
coeff3 <- as.data.frame(summary3$coefficients)

#############residual diagnostic#############
e <- model3$residuals
std.residuals <- (e - mean(e)) / sd(e)

#test for normality
ols_rsd_qqplot(model3)

ols_norm_test(model3)

#test for constant variance
plot(df2$y,std.residuals)
```



```{r}
#backward subset selection
step1 <- step(model3, direction = "backward")
step1_insignificant <- model3$coefficients[!rownames(as.data.frame(model3$coefficients)) %in% rownames(as.data.frame(step1$coefficients))]
step1_insignificant_df <- as.data.frame(step1_insignificant)

k <- ols_step_backward(model3, prem = 0.05, details = FALSE)
var_removed <- k$removed

df5 <- df4[,!colnames(df4) %in% var_removed]
```


```{r}
standard_fn <- function(col){
  if(length(unique(col)) == 2){
    ret <- col}
  else{
    ret <- scale(col)
  }
  
  return(ret)
}

y1 <- df5$y

df6 <- as.data.frame(sapply(dplyr::select(df5, -YearBuilt), standard_fn))
df6$y <- df5$y
df6$YearBuilt <- df5$YearBuilt

```

```{r}
#############ols fit2#############
model4 <- lm(y~.,df8)
summary4 <- summary(model4)
coeff4 <- as.data.frame(summary4$coefficients)

#############residual diagnostic#############
e <- model4$residuals
std.residuals <- (e - mean(e)) / sd(e)

#test for normality
ols_rsd_qqplot(model4)

ols_norm_test(model4)

#test for constant variance
plot(df8$y,std.residuals)

summary4


nums <- sapply(df6, is.numeric)

df7 <- df6[,nums]


v <- apply(df7, 2, function(x)length(unique(x)))
names(v[v>2])


boxplot(df2$BsmtFinSF1)
plot(df2$y,df2$BsmtFinSF1)

var2 <- c('LowQualFinSF','YearRemodAdd','Exterior1stWd Sdng','BsmtExposureNot available','Exterior2ndWd Shng','GarageExist')

df8 <- df6[,!colnames(df6) %in% var2]
```




```





